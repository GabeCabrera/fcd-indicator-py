//@version=5
indicator("FCD Signal with Phone Alerts", overlay=true)

// ============================================================================
// INPUTS
// ============================================================================
webhook_url   = input.string("https://fcd-indicator-py-production.up.railway.app/webhook", "Python Server URL")
ticker_symbol = input.string("SPY", "Ticker Symbol")
test_mode     = input.bool(false, "Test Mode (Alert Every Bar)")

// ============================================================================
// BUILD WEBHOOK PAYLOAD (OHLCV DATA)
// ============================================================================
build_payload() =>
    string json = "{"
    json += '"symbol":"'     + ticker_symbol + '",'
    json += '"timestamp":'   + str.tostring(time) + ','
    json += '"open":'        + str.tostring(open) + ','
    json += '"high":'        + str.tostring(high) + ','
    json += '"low":'         + str.tostring(low) + ','
    json += '"close":'       + str.tostring(close) + ','
    json += '"volume":'      + str.tostring(volume)
    json += "}"
    json

// ============================================================================
// SIMPLE PLACEHOLDER SIGNAL (for visual reference only)
// ============================================================================
// Note: Real FCD signal comes from Python server
simple_trend = ta.ema(close, 20)
var string local_signal = "HOLD"

if close > simple_trend
    local_signal := "BULLISH"
else if close < simple_trend
    local_signal := "BEARISH"
else
    local_signal := "NEUTRAL"

// ============================================================================
// SEND WEBHOOK ON BAR CLOSE
// ============================================================================
bool should_alert = test_mode ? true : barstate.isconfirmed

if should_alert
    string payload = build_payload()
    alert(payload, alert.freq_once_per_bar_close)

// ============================================================================
// STATUS TABLE
// ============================================================================
var table t = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 85), border_width=2)

if barstate.islast
    table.cell(t, 0, 0, "FCD Engine", bgcolor=color.new(color.blue, 70), text_color=color.white, text_size=size.normal)
    table.cell(t, 1, 0, "Active", text_color=color.green, text_size=size.normal)
    
    table.cell(t, 0, 1, "Symbol", text_color=color.white)
    table.cell(t, 1, 1, ticker_symbol, text_color=color.yellow)
    
    table.cell(t, 0, 2, "Price", text_color=color.white)
    table.cell(t, 1, 2, str.tostring(close, "#.##"), text_color=color.white)
    
    table.cell(t, 0, 3, "Local Trend", text_color=color.white)
    color trend_color = local_signal == "BULLISH" ? color.green : 
                       local_signal == "BEARISH" ? color.red : color.gray
    table.cell(t, 1, 3, local_signal, text_color=trend_color)
    
    table.cell(t, 0, 4, "Mode", text_color=color.white)
    table.cell(t, 1, 4, test_mode ? "TEST" : "LIVE", text_color=test_mode ? color.orange : color.aqua)
    
    table.cell(t, 0, 5, "Status", text_color=color.white)
    table.cell(t, 1, 5, "Active", text_color=color.green)

// ============================================================================
// VISUAL MARKERS
// ============================================================================
plotchar(barstate.isconfirmed, "Webhook", "â¬†", location.belowbar, color.blue, size=size.tiny)

// Plot EMA for reference
plot(simple_trend, "Trend", color=color.new(color.yellow, 50), linewidth=1)
